<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Obfuscador Lua - VM Level</title>
    <style>
        body { background: #1e1e1e; color: #f0f0f0; font-family: Arial; padding: 20px; }
        .container { background: #2e2e2e; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; }
        textarea { width: 100%; height: 200px; background: #1a1a1a; color: #00ff90; border: none; padding: 10px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #00ff90; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>Obfuscador Lua - Nível VM</h1>
    <input type="file" id="fileInput" accept=".lua,.txt"><br>
    <label>Profundidade:</label>
    <input type="number" id="depthInput" value="5" min="1" max="20"><br><br>
    <button onclick="obfuscate()">Obfuscar e Baixar</button>
    <p id="status"></p>
</div>

<script>
const charset = 'QWERTYUIOPASDFGHJKLZXCVBNMplmoknijbuhvygctfxrdzesawq1234567890+/';

function base64(str) {
    return btoa(unescape(encodeURIComponent(str)));
}

function xor(str, key) {
    let res = '';
    for (let i = 0; i < str.length; i++) {
        res += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return res;
}

function reverse(str) {
    return str.split('').reverse().join('');
}

function checksum(str) {
    let s = 0;
    for (let i = 0; i < str.length; i++) {
        s = (s + str.charCodeAt(i) * (i + 1)) % 1000000007;
    }
    return s;
}

function randomName(length = 12) {
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    return Array.from({length}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

function decoderTemplate(encoded, xorKey, check) {
    const [v1, v2, v3, v4, v5, v6, v7, v8] = Array.from({length: 8}, () => randomName());
    return `
local ${v1}='${charset}'
local function ${v2}(s)
 return (s:gsub('.',function(c)
 if c == '=' then return '' end
 local r,f='',(${v1}:find(c)-1)
 for i=6,1,-1 do r=r..(f%2^i - f%2^(i-1) > 0 and'1'or'0')end
 return r
 end):gsub('%d%d%d?%d?%d?%d?%d?%d?',function(bits)
 if #bits~=8 then return''end
 local n=0
 for i=1,8 do
 n=n+(bits:sub(i,i)=='1'and 2^(8-i)or 0)
 end
 return string.char(n)
 end))
end

local function ${v3}(s) return s:reverse() end

local function ${v4}(s,k)
 local t={}
 for i=1,#s do
  local c=s:byte(i)
  local k1=k:byte((i-1)%#k+1)
  t[#t+1]=string.char(bit32.bxor(c,k1))
 end
 return table.concat(t)
end

local function ${v5}(v)
 local s=0
 for i=1,#v do
  s=(s+v:byte(i)*i)%1000000007
 end
 return s
end

for ${v6}=1,math.random(100,200) do
 local ${v7}=${v6}*${v6}
 ${v7}=${v7}%(${v6}+1)
end

local ${v8}=${v4}(${v3}(${v2}('${encoded}')),'${xorKey}')
if ${v5}(${v8})~=${check} then return end
loadstring(${v8})()
`;
}

function recursiveObfuscate(payload, depth) {
    let current = payload;
    for (let i = 0; i < depth; i++) {
        const xorKey = Math.random().toString(36).substring(2, 8);
        const encoded = base64(reverse(xor(current, xorKey)));
        const check = checksum(current);
        current = decoderTemplate(encoded, xorKey, check);
    }
    return current;
}

function obfuscate() {
    const fileInput = document.getElementById('fileInput');
    const depthInput = document.getElementById('depthInput');
    const status = document.getElementById('status');

    if (!fileInput.files.length) {
        alert('Selecione um arquivo .lua');
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const payload = e.target.result;
        const depth = parseInt(depthInput.value);
        status.innerText = 'Obfuscando...';

        const final = recursiveObfuscate(payload, depth);
        const blob = new Blob([final], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = file.name.replace('.lua', '_obfuscated.lua');
        link.click();

        status.innerText = '✅ Código obfuscado e baixado!';
    };

    reader.readAsText(file);
}
</script>
</body>
</html>
